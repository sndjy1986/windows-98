<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 98 Desktop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
            background: linear-gradient(45deg, #008080 0%, #004040 100%);
            height: 100vh;
            overflow: hidden;
            cursor: default;
            user-select: none;
        }

        .desktop {
            position: relative;
            width: 100vw;
            height: calc(100vh - 30px);
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .desktop {
                height: calc(100vh - 40px);
                padding: 5px;
            }
            
            body {
                font-size: 12px;
            }
        }

        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, #c0c0c0 0%, #808080 100%);
            border-top: 1px solid #dfdfdf;
            border-left: 1px solid #dfdfdf;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2px;
            z-index: 1000;
        }

        /* Mobile taskbar adjustments */
        @media (max-width: 768px) {
            .taskbar {
                height: 40px;
                padding: 4px;
            }
        }

        .taskbar-left {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 0;
        }

        .start-button, .weather-button {
            height: 26px;
            padding: 0 15px;
            background: linear-gradient(to bottom, #c0c0c0 0%, #808080 100%);
            border: 2px outset #c0c0c0;
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 11px;
            gap: 5px;
            white-space: nowrap;
        }

        /* Mobile button adjustments */
        @media (max-width: 768px) {
            .start-button, .weather-button {
                height: 32px;
                padding: 0 10px;
                font-size: 12px;
            }
        }

        .start-button:active, .weather-button:active {
            border: 2px inset #c0c0c0;
        }

        .running-apps {
            display: flex;
            align-items: center;
            gap: 2px;
            flex: 1;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .running-apps::-webkit-scrollbar {
            display: none;
        }

        .app-button {
            height: 26px;
            padding: 0 12px;
            background: linear-gradient(to bottom, #c0c0c0 0%, #808080 100%);
            border: 2px outset #c0c0c0;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 80px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Mobile app button adjustments */
        @media (max-width: 768px) {
            .app-button {
                height: 32px;
                min-width: 60px;
                max-width: 100px;
                padding: 0 8px;
                font-size: 10px;
            }
        }

        .app-button:active {
            border: 2px inset #c0c0c0;
        }

        .app-button.active {
            background: linear-gradient(to bottom, #808080 0%, #c0c0c0 100%);
            border: 2px inset #c0c0c0;
        }

        .system-tray {
            height: 26px;
            background: linear-gradient(to bottom, #c0c0c0 0%, #808080 100%);
            border: 1px inset #c0c0c0;
            padding: 3px 8px;
            font-size: 11px;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Mobile system tray adjustments */
        @media (max-width: 768px) {
            .system-tray {
                height: 32px;
                min-width: 60px;
                font-size: 9px;
                padding: 2px 4px;
            }
        }

        .desktop-icon {
            position: absolute;
            width: 64px;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            padding: 2px;
            border-radius: 2px;
            transition: background-color 0.1s;
        }

        /* Mobile icon adjustments */
        @media (max-width: 768px) {
            .desktop-icon {
                width: 56px;
                height: 65px;
                position: relative !important;
                display: inline-flex;
                margin: 5px;
            }
            
            .desktop {
                display: flex;
                flex-wrap: wrap;
                align-content: flex-start;
                justify-content: flex-start;
            }
        }

        .desktop-icon:hover {
            background-color: rgba(0, 0, 255, 0.1);
        }

        .desktop-icon.selected {
            background-color: rgba(0, 0, 255, 0.3);
        }

        .desktop-icon img {
            width: 32px;
            height: 32px;
            margin-bottom: 4px;
        }

        /* Mobile icon image adjustments */
        @media (max-width: 768px) {
            .desktop-icon img {
                width: 28px;
                height: 28px;
            }
        }

        .desktop-icon .icon-emoji {
            font-size: 32px;
            margin-bottom: 4px;
            line-height: 32px;
        }

        /* Mobile emoji adjustments */
        @media (max-width: 768px) {
            .desktop-icon .icon-emoji {
                font-size: 28px;
                line-height: 28px;
            }
        }

        .desktop-icon span {
            color: white;
            font-size: 11px;
            text-align: center;
            word-wrap: break-word;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            line-height: 12px;
            max-width: 60px;
        }

        /* Mobile text adjustments */
        @media (max-width: 768px) {
            .desktop-icon span {
                font-size: 10px;
                line-height: 11px;
                max-width: 50px;
            }
        }

        .start-menu {
            position: fixed;
            bottom: 30px;
            left: 2px;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            box-shadow: 2px -2px 5px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1001;
            min-width: 180px;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }

        /* Mobile start menu adjustments */
        @media (max-width: 768px) {
            .start-menu {
                bottom: 40px;
                min-width: 160px;
                max-height: calc(100vh - 80px);
            }
        }

        .start-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #808080;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Mobile menu item adjustments */
        @media (max-width: 768px) {
            .start-menu-item {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        .start-menu-item:hover {
            background: #0080ff;
            color: white;
        }

        .start-menu-item:last-child {
            border-bottom: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            width: 400px;
            max-width: 100%;
            max-height: 90vh;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .weather-modal-content {
            width: 500px;
            max-width: 100%;
        }

        /* Mobile modal adjustments */
        @media (max-width: 768px) {
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
            }
            
            .weather-modal-content {
                width: 100%;
            }
        }

        .modal-header {
            background: linear-gradient(90deg, #0080ff, #004080);
            color: white;
            padding: 3px 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            flex-shrink: 0;
        }

        .modal-close {
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            width: 18px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
        }

        /* Mobile close button adjustments */
        @media (max-width: 768px) {
            .modal-close {
                width: 24px;
                height: 20px;
                font-size: 12px;
            }
        }

        .modal-close:hover {
            background: #ff4444;
            color: white;
        }

        .modal-body {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        /* Mobile modal body adjustments */
        @media (max-width: 768px) {
            .modal-body {
                padding: 10px;
            }
        }

        .weather-app {
            padding: 0;
            overflow-y: auto;
            max-height: 100%;
        }

        .current-weather {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #808080;
        }

        /* Mobile weather adjustments */
        @media (max-width: 768px) {
            .current-weather {
                padding: 15px;
            }
        }

        .current-temp {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        /* Mobile temperature adjustments */
        @media (max-width: 768px) {
            .current-temp {
                font-size: 28px;
            }
        }

        .current-location {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .current-condition {
            font-size: 12px;
            color: #666;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px solid #808080;
        }

        /* Mobile weather details adjustments */
        @media (max-width: 480px) {
            .weather-details {
                grid-template-columns: 1fr;
                gap: 5px;
                padding: 10px;
            }
        }

        .weather-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .forecast-section {
            padding: 15px;
        }

        /* Mobile forecast adjustments */
        @media (max-width: 768px) {
            .forecast-section {
                padding: 10px;
            }
        }

        .forecast-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .forecast-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        /* Mobile forecast container adjustments */
        @media (max-width: 480px) {
            .forecast-container {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }

        .forecast-day {
            text-align: center;
            padding: 10px;
            border: 1px inset #c0c0c0;
            background: #f0f0f0;
        }

        /* Mobile forecast day adjustments */
        @media (max-width: 768px) {
            .forecast-day {
                padding: 8px;
            }
        }

        .forecast-day-name {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .forecast-icon {
            font-size: 24px;
            margin: 5px 0;
        }

        /* Mobile forecast icon adjustments */
        @media (max-width: 768px) {
            .forecast-icon {
                font-size: 20px;
                margin: 3px 0;
            }
        }

        .forecast-temps {
            font-size: 10px;
        }

        .forecast-high {
            font-weight: bold;
        }

        .forecast-low {
            color: #666;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 2px 4px;
            border: 1px inset #c0c0c0;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
        }

        /* Mobile form adjustments */
        @media (max-width: 768px) {
            .form-group input, .form-group select {
                padding: 6px 8px;
                font-size: 12px;
            }
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 15px;
        }

        /* Mobile button group adjustments */
        @media (max-width: 768px) {
            .button-group {
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        .button {
            padding: 4px 16px;
            background: linear-gradient(to bottom, #c0c0c0 0%, #808080 100%);
            border: 2px outset #c0c0c0;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
            cursor: pointer;
        }

        /* Mobile button adjustments */
        @media (max-width: 768px) {
            .button {
                padding: 8px 20px;
                font-size: 12px;
                min-width: 80px;
            }
        }

        .button:active {
            border: 2px inset #c0c0c0;
        }

        .context-menu {
            position: fixed;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1001;
            min-width: 140px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .context-menu-item {
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #808080;
        }

        /* Mobile context menu adjustments */
        @media (max-width: 768px) {
            .context-menu-item {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        .context-menu-item:hover {
            background: #0080ff;
            color: white;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .dragging {
            opacity: 0.7;
            z-index: 100;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Touch-friendly adjustments */
        @media (pointer: coarse) {
            .desktop-icon, .start-menu-item, .context-menu-item, 
            .app-button, .start-button, .button {
                cursor: pointer;
            }
        }

        /* Landscape phone adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .desktop {
                height: calc(100vh - 35px);
            }
            
            .taskbar {
                height: 35px;
            }
            
            .start-button, .app-button, .system-tray {
                height: 30px;
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            .desktop {
                padding: 3px;
            }
            
            .desktop-icon {
                width: 50px;
                height: 55px;
                margin: 3px;
            }
            
            .desktop-icon img, .desktop-icon .icon-emoji {
                width: 24px;
                height: 24px;
                font-size: 24px;
                line-height: 24px;
            }
            
            .desktop-icon span {
                font-size: 9px;
                line-height: 10px;
                max-width: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="desktop" id="desktop">
        <!-- Default icons with proper Windows 98 spacing -->
       <div class="desktop-icon" style="left: 15px; top: 15px;" data-url="https://www.paycomonline.net/v4/ee/web.php/app/login" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/paycomonline.net.ico">
            <img src="https://icons.duckduckgo.com/ip3/paycomonline.net.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>PayCom Online</span>
        </div>
       <div class="desktop-icon" style="left: 15px; top: 95px;" data-url="https://slack.com/" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/slack.com.ico">
            <img src="https://icons.duckduckgo.com/ip3/slack.com.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>Slack</span>
        </div>
             <div class="desktop-icon" style="left: 15px; top: 175px;" data-url="https://andersoncounty911_sc.transport.net/#/home/dashboard?facilityId=52109&operation=upcomingTrips" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/med-trans.net.ico">
            <img src="https://icons.duckduckgo.com/ip3/med-trans.net.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>Lifeflight OLS</span>
        </div>
             <div class="desktop-icon" style="left: 15px; top: 255px;" data-url="https://learn.emergencydispatch.org/academy/my_learning/dashboard" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/emergencydispatch.org.ico">
            <img src="https://icons.duckduckgo.com/ip3/emergencydispatch.org.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>IAED EMD</span>
        </div>
            <div class="desktop-icon" style="left: 15px; top: 335px;" data-url="https://vanguard.emsanyware.com/" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/emsanyware.com.ico">
            <img src="https://icons.duckduckgo.com/ip3/emsanyware.com.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>Vanguard</span>
        </div>
            <div class="desktop-icon" style="left: 15px; top: 415px;" data-url="https://priorityambulance.com/" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/priority.com.ico">
            <img src="https://icons.duckduckgo.com/ip3/priority.com.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>Priority Ambulance</span>
        </div>
            <div class="desktop-icon" style="left: 15px; top: 495px;" data-url="https://forms.microsoft.com/pages/responsepage.aspx?id=Zh-exeJVn0SAfe_1FF9Zi2FaRW6gaHhKjeF02t2Aq8tURFAwVDVVUEVVRzZRODNTNkgyUFJNMDBHSS4u" data-icon="🖥️" data-icon-type="image" data-image-url="https://raw.githubusercontent.com/sndjy1986/_traichu/refs/heads/main/form.png">
            <img src="https://raw.githubusercontent.com/sndjy1986/_traichu/refs/heads/main/form.png" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>Daily Truck Form</span>
        </div>
            <div class="desktop-icon" style="left: 15px; top: 575px;" data-url="https://anmed.org/sites/default/files/2024-08/anmed-north-campus-map-v5.pdf" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/anmed.org.ico">
            <img src="https://icons.duckduckgo.com/ip3/anmed.org.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>North Campus Map</span>
        </div>
            <div class="desktop-icon" style="left: 15px; top: 670px;" data-url="https://www.511sc.org/#zoom=11.546860821896603&lon=-82.55557766187724&lat=34.58726185125286&dmsg&rest&cams&other&cong&wthr&acon&incd&trfc" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/511sc.org.ico">
            <img src="https://icons.duckduckgo.com/ip3/511sc.org.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>SC DOT Camera's</span>
        </div>
            <div class="desktop-icon" style="left: 15px; top: 750px;" data-url="https://drive.google.com/drive/folders/1Qzn_8PrPBanI6P5IC9Jovt3qDSLiJH9v?usp=drive_link" data-icon="🖥️" data-icon-type="image" data-image-url="https://raw.githubusercontent.com/sndjy1986/windows-98/refs/heads/main/folder.png">
            <img src="https://raw.githubusercontent.com/sndjy1986/windows-98/refs/heads/main/folder.png" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>Saved Reports</span>        
        </div>
            <div class="desktop-icon" style="left: 15px; top: 830px;" data-url="https://support.priorityambulance.com/helpdesk/WebObjects/Helpdesk.woa" data-icon="🖥️" data-icon-type="image" data-image-url="https://raw.githubusercontent.com/sndjy1986/_traichu/refs/heads/main/support.JPG">
            <img src="https://raw.githubusercontent.com/sndjy1986/_traichu/refs/heads/main/support.JPG" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>Priority Computer Support</span>    
        </div>
            <div class="desktop-icon" style="left: 15px; top: 830px;" data-url="https://voice.google.com/u/0/messages" data-icon="🖥️" data-icon-type="image" data-image-url="https://icons.duckduckgo.com/ip3/voice.google.com.ico">
            <img src="https://icons.duckduckgo.com/ip3/voice.google.com.ico" style="width: 42px; height: 42px; margin-bottom: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="icon-emoji" style="display: none;">🖥️</div>
            <span>Google Voice</span>    
        </div>
    </div>

    <div class="taskbar">
        <div class="taskbar-left">
            <button class="start-button" onclick="toggleStartMenu()">
                Start
            </button>
            <div id="runningApps" class="running-apps">
                <!-- Running applications will appear here -->
            </div>
        </div>
        <div style="flex: 1;"></div>
        <div class="system-tray" id="systemTray">
            <span id="timeDisplay"></span>
        </div>
    </div>

    <!-- Start Menu -->
    <div class="start-menu" id="startMenu">
        <div class="start-menu-item" onclick="openWeatherApp()">
            <span>🌤️</span>Weather
        </div>
        <div class="start-menu-item" onclick="requireAdminAuth(() => addNewIcon())">
            <span>📄</span>Add New Icon
        </div>
        <div class="start-menu-item" onclick="requireAdminAuth(() => editIcon(currentIcon))">
            <span>✏️</span>Edit Icon
        </div>
        <div class="start-menu-item" onclick="requireAdminAuth(() => deleteIcon(currentIcon))">
            <span>🗑️</span>Delete Icon
        </div>
        <div class="start-menu-item" onclick="requireAdminAuth(() => exportConfig())">
            <span>💾</span>Export Config
        </div>
        <div class="start-menu-item" onclick="requireAdminAuth(() => importConfig())">
            <span>📂</span>Import Config
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="requireAdminAuth(() => addNewIcon())">Add New Icon</div>
        <div class="context-menu-item" onclick="requireAdminAuth(() => editIcon(currentIcon))">Edit Icon</div>
        <div class="context-menu-item" onclick="requireAdminAuth(() => deleteIcon(currentIcon))">Delete Icon</div>
        <div class="context-menu-item" onclick="requireAdminAuth(() => exportConfig())">Export Config</div>
        <div class="context-menu-item" onclick="requireAdminAuth(() => importConfig())">Import Config</div>
    </div>

    <!-- Import File Input (hidden) -->
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">

    <!-- Weather App Modal -->
    <div class="modal" id="weatherModal">
        <div class="modal-content weather-modal-content">
            <div class="modal-header">
                <span>🌤️ Weather</span>
                <button class="modal-close" onclick="closeWeatherApp()">×</button>
            </div>
            <div class="weather-app">
                <div id="weatherLoading" class="loading">
                    Loading weather data...
                </div>
                <div id="weatherContent" style="display: none;">
                    <div class="current-weather">
                        <div class="current-location" id="currentLocation">Anderson, SC</div>
                        <div id="currentWeatherIcon">🌤️</div>
                        <div class="current-temp" id="currentTemp">--°F</div>
                        <div class="current-condition" id="currentCondition">Loading...</div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="weather-detail">
                            <span>Feels like:</span>
                            <span id="feelsLike">--°F</span>
                        </div>
                        <div class="weather-detail">
                            <span>Humidity:</span>
                            <span id="humidity">--%</span>
                        </div>
                        <div class="weather-detail">
                            <span>Wind:</span>
                            <span id="windSpeed">-- mph</span>
                        </div>
                        <div class="weather-detail">
                            <span>Pressure:</span>
                            <span id="pressure">-- mb</span>
                        </div>
                    </div>
                    
                    <div class="forecast-section">
                        <div class="forecast-title">3-Day Forecast</div>
                        <div class="forecast-container" id="forecastContainer">
                            <!-- Forecast days will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Administrator Access Required</span>
                <button class="modal-close" onclick="closeAdminModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="adminPassword">Enter Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Password">
                </div>
                <div class="button-group">
                    <button class="button" onclick="closeAdminModal()">Cancel</button>
                    <button class="button" onclick="checkAdminPassword()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding/editing icons -->
    <div class="modal" id="iconModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">Add New Icon</span>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="iconName">Name:</label>
                    <input type="text" id="iconName" placeholder="Enter icon name">
                </div>
                <div class="form-group">
                    <label for="iconUrl">URL:</label>
                    <input type="text" id="iconUrl" placeholder="Enter website URL">
                </div>
                <div class="form-group">
                    <label for="iconEmoji">Icon (Emoji):</label>
                    <select id="iconEmoji">
                        <option value="🖥️">🖥️ Computer</option>
                        <option value="📁">📁 Folder</option>
                        <option value="📄">📄 Document</option>
                        <option value="🌐">🌐 Internet</option>
                        <option value="📺">📺 Entertainment</option>
                        <option value="🎮">🎮 Games</option>
                        <option value="📧">📧 Email</option>
                        <option value="📱">📱 Apps</option>
                        <option value="🛒">🛒 Shopping</option>
                        <option value="🎵">🎵 Music</option>
                        <option value="📸">📸 Photos</option>
                        <option value="💼">💼 Work</option>
                        <option value="🔧">🔧 Tools</option>
                        <option value="📚">📚 Education</option>
                        <option value="🏠">🏠 Home</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="button" onclick="closeModal()">Cancel</button>
                    <button class="button" onclick="saveIcon()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let draggedIcon = null;
        let currentIcon = null;
        let iconCounter = 0;
        let isAdminAuthenticated = false;
        const ADMIN_PASSWORD = "admin123";
        let pendingAdminAction = null;
        let weatherData = null;
        let isWeatherAppOpen = false;
        let runningApps = [];
        let isMobile = window.innerWidth <= 768;

        // Weather API configuration
        const WEATHER_API_KEY = "8b093586dd2c02084b20747b888d3cfa";
        const WEATHER_LOCATION = "Anderson,SC,US";

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                updateTime();
                setInterval(updateTime, 1000);
                setupIconDragging();
                setupEventListeners();
                setupModalDragging();
                fetchWeatherData();
                setInterval(fetchWeatherData, 600000); // Update weather every 10 minutes
                handleResize();
                window.addEventListener('resize', handleResize);
                window.addEventListener('orientationchange', () => {
                    setTimeout(handleResize, 100); // Delay to ensure orientation change is complete
                });
                
                // Initial layout calculation
                setTimeout(calculateOptimalIconLayout, 100);
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        // Handle responsive layout changes
        function handleResize() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            
            if (wasMobile !== isMobile) {
                adjustLayoutForScreenSize();
            } else {
                // Even if we're staying in the same mode, recalculate positions
                calculateOptimalIconLayout();
            }
        }

        function adjustLayoutForScreenSize() {
            const icons = document.querySelectorAll('.desktop-icon');
            const desktop = document.getElementById('desktop');
            
            if (isMobile) {
                // Switch to mobile layout - remove absolute positioning
                icons.forEach(icon => {
                    icon.style.position = 'relative';
                    icon.style.left = 'auto';
                    icon.style.top = 'auto';
                });
                desktop.style.display = 'flex';
                desktop.style.flexWrap = 'wrap';
                desktop.style.alignContent = 'flex-start';
                desktop.style.justifyContent = 'flex-start';
            } else {
                // Switch back to desktop layout with smart positioning
                desktop.style.display = 'block';
                desktop.style.alignContent = 'unset';
                desktop.style.justifyContent = 'unset';
                calculateOptimalIconLayout();
            }
        }

        function calculateOptimalIconLayout() {
            const icons = document.querySelectorAll('.desktop-icon');
            if (icons.length === 0 || isMobile) return;

            const desktop = document.getElementById('desktop');
            const desktopRect = desktop.getBoundingClientRect();
            
            // Calculate available space
            const availableWidth = desktopRect.width - 20; // Account for padding
            const availableHeight = desktopRect.height - 20;
            
            // Icon dimensions
            const iconWidth = 80;  // Including spacing
            const iconHeight = 90; // Including spacing
            
            // Calculate how many icons fit per column (going down first)
            const iconsPerCol = Math.floor(availableHeight / iconHeight);
            
            // Start from left side, top position
            const startX = 15; // Left margin
            const startY = 15; // Top margin
            
            // Position each icon - fill columns from left to right, top to bottom
            icons.forEach((icon, index) => {
                icon.style.position = 'absolute';
                
                const col = Math.floor(index / iconsPerCol); // Which column (left to right)
                const row = index % iconsPerCol; // Which row within that column (top to bottom)
                
                const x = startX + (col * iconWidth);
                const y = startY + (row * iconHeight);
                
                // Ensure icon stays within bounds
                const maxX = availableWidth - 64; // Icon width
                const maxY = availableHeight - 70; // Icon height
                
                icon.style.left = Math.min(x, maxX) + 'px';
                icon.style.top = Math.min(y, maxY) + 'px';
            });
        }

        function autoArrangeIcons() {
            // Public function to manually trigger icon rearrangement
            if (!isMobile) {
                calculateOptimalIconLayout();
            }
        }

        // Weather functions
        async function fetchWeatherData() {
            try {
                // Fetch current weather
                const currentResponse = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?q=${WEATHER_LOCATION}&appid=${WEATHER_API_KEY}&units=imperial`
                );
                
                // Fetch forecast
                const forecastResponse = await fetch(
                    `https://api.openweathermap.org/data/2.5/forecast?q=${WEATHER_LOCATION}&appid=${WEATHER_API_KEY}&units=imperial`
                );
                
                if (currentResponse.ok && forecastResponse.ok) {
                    const currentData = await currentResponse.json();
                    const forecastData = await forecastResponse.json();
                    
                    weatherData = {
                        current: currentData,
                        forecast: forecastData
                    };
                } else {
                    console.error('Weather API error');
                }
            } catch (error) {
                console.error('Weather fetch error:', error);
            }
        }

        function openWeatherApp() {
            if (isWeatherAppOpen) {
                // If already open, just focus it
                const weatherModal = document.getElementById('weatherModal');
                if (weatherModal) {
                    weatherModal.style.display = 'flex';
                }
                return;
            }

            isWeatherAppOpen = true;
            addAppToTaskbar('weather', '🌤️ Weather', () => focusWeatherApp());
            
            const weatherModal = document.getElementById('weatherModal');
            const weatherLoading = document.getElementById('weatherLoading');
            const weatherContent = document.getElementById('weatherContent');
            
            if (weatherModal) {
                weatherModal.style.display = 'flex';
                
                if (weatherData) {
                    populateWeatherApp();
                    weatherLoading.style.display = 'none';
                    weatherContent.style.display = 'block';
                } else {
                    weatherLoading.style.display = 'block';
                    weatherContent.style.display = 'none';
                    // Try to fetch weather data if not available
                    fetchWeatherData().then(() => {
                        if (weatherData) {
                            populateWeatherApp();
                            weatherLoading.style.display = 'none';
                            weatherContent.style.display = 'block';
                        }
                    });
                }
            }
            hideAllMenus();
        }

        function focusWeatherApp() {
            const weatherModal = document.getElementById('weatherModal');
            if (weatherModal) {
                weatherModal.style.display = 'flex';
            }
        }

        function closeWeatherApp() {
            isWeatherAppOpen = false;
            removeAppFromTaskbar('weather');
            
            const weatherModal = document.getElementById('weatherModal');
            if (weatherModal) {
                weatherModal.style.display = 'none';
            }
        }

        function addAppToTaskbar(appId, appName, clickHandler) {
            if (runningApps.find(app => app.id === appId)) {
                return; // App already in taskbar
            }

            const app = { id: appId, name: appName, clickHandler: clickHandler };
            runningApps.push(app);
            updateTaskbar();
        }

        function removeAppFromTaskbar(appId) {
            runningApps = runningApps.filter(app => app.id !== appId);
            updateTaskbar();
        }

        function updateTaskbar() {
            const runningAppsContainer = document.getElementById('runningApps');
            runningAppsContainer.innerHTML = '';

            runningApps.forEach(app => {
                const appButton = document.createElement('button');
                appButton.className = 'app-button';
                appButton.innerHTML = app.name;
                appButton.onclick = app.clickHandler;
                runningAppsContainer.appendChild(appButton);
            });
        }

        function populateWeatherApp() {
            if (!weatherData) return;
            
            const current = weatherData.current;
            const forecast = weatherData.forecast;
            
            // Update current weather
            document.getElementById('currentLocation').textContent = current.name + ', ' + current.sys.country;
            document.getElementById('currentWeatherIcon').textContent = getWeatherEmoji(current.weather[0].main);
            document.getElementById('currentTemp').textContent = Math.round(current.main.temp) + '°F';
            document.getElementById('currentCondition').textContent = current.weather[0].description;
            
            // Update weather details
            document.getElementById('feelsLike').textContent = Math.round(current.main.feels_like) + '°F';
            document.getElementById('humidity').textContent = current.main.humidity + '%';
            document.getElementById('windSpeed').textContent = Math.round(current.wind.speed) + ' mph';
            document.getElementById('pressure').textContent = current.main.pressure + ' mb';
            
            // Update 3-day forecast
            populateForecast(forecast);
        }

        function populateForecast(forecastData) {
            const forecastContainer = document.getElementById('forecastContainer');
            forecastContainer.innerHTML = '';
            
            // Group forecast by day and take one entry per day
            const dailyForecasts = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            
            forecastData.list.forEach(item => {
                const date = new Date(item.dt * 1000);
                const dateKey = date.toDateString();
                
                // Only take forecasts for the next 3 days (excluding today)
                const daysDiff = Math.floor((date - today) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 0 && daysDiff <= 3) {
                    // Take the forecast around noon for better representation
                    if (!dailyForecasts[dateKey] || Math.abs(date.getHours() - 12) < Math.abs(new Date(dailyForecasts[dateKey].dt * 1000).getHours() - 12)) {
                        dailyForecasts[dateKey] = item;
                    }
                }
            });
            
            // Convert to array and sort by date
            const forecastDays = Object.values(dailyForecasts)
                .sort((a, b) => a.dt - b.dt)
                .slice(0, 3);
            
            forecastDays.forEach(day => {
                const date = new Date(day.dt * 1000);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const monthDay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                const forecastDiv = document.createElement('div');
                forecastDiv.className = 'forecast-day';
                forecastDiv.innerHTML = `
                    <div class="forecast-day-name">${dayName}</div>
                    <div style="font-size: 9px; color: #666; margin-bottom: 3px;">${monthDay}</div>
                    <div class="forecast-icon">${getWeatherEmoji(day.weather[0].main)}</div>
                    <div class="forecast-temps">
                        <div class="forecast-high">${Math.round(day.main.temp_max)}°</div>
                        <div class="forecast-low">${Math.round(day.main.temp_min)}°</div>
                    </div>
                    <div style="font-size: 9px; color: #666; margin-top: 3px; text-align: center;">${day.weather[0].description}</div>
                `;
                
                forecastContainer.appendChild(forecastDiv);
            });
        }

        function getWeatherEmoji(condition) {
            const iconMap = {
                'Clear': '☀️',
                'Clouds': '☁️',
                'Rain': '🌧️',
                'Drizzle': '🌦️',
                'Thunderstorm': '⛈️',
                'Snow': '❄️',
                'Mist': '🌫️',
                'Fog': '🌫️',
                'Haze': '🌫️'
            };
            return iconMap[condition] || '🌤️';
        }

        // Window dragging functionality (disabled on mobile)
        function setupModalDragging() {
            if (isMobile) return; // Disable dragging on mobile
            
            const weatherModal = document.getElementById('weatherModal');
            const weatherHeader = weatherModal.querySelector('.modal-header');
            
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };
            
            weatherHeader.addEventListener('mousedown', function(e) {
                isDragging = true;
                const modalContent = weatherModal.querySelector('.modal-content');
                const rect = modalContent.getBoundingClientRect();
                
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                weatherHeader.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const modalContent = weatherModal.querySelector('.modal-content');
                let newX = e.clientX - dragOffset.x;
                let newY = e.clientY - dragOffset.y;
                
                // Keep window within viewport bounds
                const maxX = window.innerWidth - modalContent.offsetWidth;
                const maxY = window.innerHeight - modalContent.offsetHeight;
                
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
                
                modalContent.style.position = 'fixed';
                modalContent.style.left = newX + 'px';
                modalContent.style.top = newY + 'px';
                modalContent.style.margin = '0';
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    weatherHeader.style.cursor = 'move';
                }
            });
        }

        // Start menu functions
        function toggleStartMenu() {
            const startMenu = document.getElementById('startMenu');
            if (startMenu) {
                if (startMenu.style.display === 'block') {
                    startMenu.style.display = 'none';
                } else {
                    startMenu.style.display = 'block';
                }
            }
        }

        // Update time display
        function updateTime() {
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    hour12: true,
                    hour: 'numeric',
                    minute: '2-digit'
                });
                const dateString = now.toLocaleDateString('en-US', {
                    month: 'numeric',
                    day: 'numeric',
                    year: isMobile ? '2-digit' : 'numeric' // Shorter date on mobile
                });
                const timeDisplay = document.getElementById('timeDisplay');
                if (timeDisplay) {
                    timeDisplay.textContent = `${timeString} ${dateString}`;
                }
            } catch (error) {
                console.error('Time update error:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Hide menus when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.context-menu') && !e.target.closest('.start-menu') && !e.target.closest('.start-button')) {
                    const contextMenu = document.getElementById('contextMenu');
                    const startMenu = document.getElementById('startMenu');
                    if (contextMenu) {
                        contextMenu.style.display = 'none';
                    }
                    if (startMenu) {
                        startMenu.style.display = 'none';
                    }
                }
            });

            // Handle Enter key in password field
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const adminModal = document.getElementById('adminModal');
                    if (adminModal && adminModal.style.display === 'flex') {
                        checkAdminPassword();
                    }
                }
            });

            // Handle desktop right-click for adding icons
            const desktop = document.getElementById('desktop');
            if (desktop) {
                desktop.addEventListener('contextmenu', function(e) {
                    if (e.target === this) {
                        currentIcon = null;
                        showContextMenu(e);
                    }
                });
            }

            // Handle touch events on mobile
            if (isMobile) {
                setupTouchEvents();
            }
        }

        function setupTouchEvents() {
            // Add touch event handling for mobile
            const desktop = document.getElementById('desktop');
            let touchStartTime = 0;
            
            desktop.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
            });
            
            desktop.addEventListener('touchend', function(e) {
                const touchDuration = Date.now() - touchStartTime;
                if (touchDuration > 500) { // Long press
                    e.preventDefault();
                    currentIcon = null;
                    showContextMenu({
                        clientX: e.changedTouches[0].clientX,
                        clientY: e.changedTouches[0].clientY,
                        preventDefault: () => {}
                    });
                }
            });
        }

        // Icon drag and drop functionality
        function setupIconDragging() {
            const icons = document.querySelectorAll('.desktop-icon');
            
            icons.forEach(icon => {
                if (!isMobile) {
                    icon.addEventListener('mousedown', handleMouseDown);
                }
                icon.addEventListener('dblclick', handleDoubleClick);
                icon.addEventListener('contextmenu', handleRightClick);
                
                // Touch events for mobile
                if (isMobile) {
                    icon.addEventListener('touchstart', handleTouchStart);
                    icon.addEventListener('touchend', handleTouchEnd);
                }
            });
        }

        let touchStartTime = 0;
        let touchStartIcon = null;

        function handleTouchStart(e) {
            touchStartTime = Date.now();
            touchStartIcon = e.currentTarget;
        }

        function handleTouchEnd(e) {
            const touchDuration = Date.now() - touchStartTime;
            if (touchDuration < 300) {
                // Short tap - open app
                handleDoubleClick(e);
            } else if (touchDuration > 500) {
                // Long press - show context menu
                e.preventDefault();
                currentIcon = touchStartIcon;
                showContextMenu({
                    clientX: e.changedTouches[0].clientX,
                    clientY: e.changedTouches[0].clientY,
                    preventDefault: () => {}
                });
            }
        }

        function handleMouseDown(e) {
            if (isMobile) return; // Disable mouse dragging on mobile
            
            if (e.button === 0) { // Left click only
                draggedIcon = e.currentTarget;
                const rect = draggedIcon.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const offsetY = e.clientY - rect.top;

                draggedIcon.classList.add('dragging');

                function handleMouseMove(e) {
                    if (draggedIcon) {
                        const desktop = document.getElementById('desktop');
                        const desktopRect = desktop.getBoundingClientRect();
                        
                        let newX = e.clientX - desktopRect.left - offsetX;
                        let newY = e.clientY - desktopRect.top - offsetY;

                        // Keep icon within desktop bounds
                        newX = Math.max(0, Math.min(newX, desktopRect.width - 64));
                        newY = Math.max(0, Math.min(newY, desktopRect.height - 70));

                        draggedIcon.style.left = newX + 'px';
                        draggedIcon.style.top = newY + 'px';
                    }
                }

                function handleMouseUp() {
                    if (draggedIcon) {
                        draggedIcon.classList.remove('dragging');
                        draggedIcon = null;
                    }
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                }

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            }
        }

        function handleDoubleClick(e) {
            const url = e.currentTarget.dataset.url;
            if (url) {
                window.open(url, '_blank');
            }
        }

        function handleRightClick(e) {
            e.preventDefault();
            currentIcon = e.currentTarget;
            showContextMenu(e);
        }

        function showContextMenu(e) {
            e.preventDefault();
            const contextMenu = document.getElementById('contextMenu');
            const startMenu = document.getElementById('startMenu');
            
            if (contextMenu) {
                contextMenu.style.display = 'block';
                
                // Adjust position for mobile
                let x = e.clientX;
                let y = e.clientY;
                
                if (isMobile) {
                    // Center the menu better on mobile
                    x = Math.min(x, window.innerWidth - 140);
                    y = Math.min(y, window.innerHeight - 200);
                }
                
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
            }
            if (startMenu) {
                startMenu.style.display = 'none';
            }
        }

        // Admin authentication functions
        function requireAdminAuth(action) {
            if (isAdminAuthenticated) {
                action();
            } else {
                pendingAdminAction = action;
                const adminModal = document.getElementById('adminModal');
                if (adminModal) {
                    adminModal.style.display = 'flex';
                    const passwordField = document.getElementById('adminPassword');
                    if (passwordField) {
                        passwordField.focus();
                    }
                }
            }
        }

        function checkAdminPassword() {
            const passwordField = document.getElementById('adminPassword');
            if (passwordField) {
                const enteredPassword = passwordField.value;
                if (enteredPassword === ADMIN_PASSWORD) {
                    isAdminAuthenticated = true;
                    closeAdminModal();
                    if (pendingAdminAction) {
                        pendingAdminAction();
                        pendingAdminAction = null;
                    }
                } else {
                    alert('Incorrect password. Access denied.');
                    passwordField.value = '';
                }
            }
        }

        function closeAdminModal() {
            const adminModal = document.getElementById('adminModal');
            const passwordField = document.getElementById('adminPassword');
            if (adminModal) {
                adminModal.style.display = 'none';
            }
            if (passwordField) {
                passwordField.value = '';
            }
        }

        // Create icon element
        function createIconElement(iconData) {
            const newIcon = document.createElement('div');
            newIcon.className = 'desktop-icon';
            
            // Don't set initial position - let the layout system handle it
            newIcon.dataset.url = iconData.url;
            newIcon.dataset.icon = iconData.emoji;
            newIcon.dataset.id = iconData.id;
            
            newIcon.innerHTML = `
                <div class="icon-emoji">${iconData.emoji}</div>
                <span>${iconData.name}</span>
            `;

            const desktop = document.getElementById('desktop');
            if (desktop) {
                desktop.appendChild(newIcon);
            }

            // Setup event listeners for the new icon
            if (!isMobile) {
                newIcon.addEventListener('mousedown', handleMouseDown);
            } else {
                newIcon.addEventListener('touchstart', handleTouchStart);
                newIcon.addEventListener('touchend', handleTouchEnd);
            }
            newIcon.addEventListener('dblclick', handleDoubleClick);
            newIcon.addEventListener('contextmenu', handleRightClick);
            
            // Trigger layout recalculation after adding new icon
            setTimeout(() => {
                if (!isMobile) {
                    calculateOptimalIconLayout();
                }
            }, 10);
        }

        // Export configuration to JSON file
        function exportConfig() {
            try {
                const icons = [];
                document.querySelectorAll('.desktop-icon').forEach(icon => {
                    const nameElement = icon.querySelector('span');
                    const emojiElement = icon.querySelector('.icon-emoji');
                    if (nameElement && emojiElement) {
                        icons.push({
                            name: nameElement.textContent,
                            url: icon.dataset.url,
                            emoji: icon.dataset.icon,
                            left: icon.style.left,
                            top: icon.style.top,
                            id: icon.dataset.id || Math.random().toString(36).substr(2, 9)
                        });
                    }
                });

                const config = {
                    icons: icons,
                    exportDate: new Date().toISOString(),
                    version: "1.0"
                };

                const dataStr = JSON.stringify(config, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'desktop-config.json';
                link.click();
                
                URL.revokeObjectURL(url);
                hideAllMenus();
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting configuration.');
            }
        }

        // Import configuration from JSON file
        function importConfig() {
            const importFile = document.getElementById('importFile');
            if (importFile) {
                importFile.click();
            }
            hideAllMenus();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    if (config.icons && Array.isArray(config.icons)) {
                        // Clear existing icons
                        document.querySelectorAll('.desktop-icon').forEach(icon => icon.remove());
                        
                        // Load imported icons
                        config.icons.forEach(iconData => {
                            createIconElement(iconData);
                        });
                        
                        alert('Configuration imported successfully!');
                        
                        // Adjust layout after import with a delay to ensure DOM is updated
                        setTimeout(() => {
                            adjustLayoutForScreenSize();
                            if (!isMobile) {
                                calculateOptimalIconLayout();
                            }
                        }, 100);
                    } else {
                        alert('Invalid configuration file format.');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error reading configuration file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function hideAllMenus() {
            const contextMenu = document.getElementById('contextMenu');
            const startMenu = document.getElementById('startMenu');
            if (contextMenu) contextMenu.style.display = 'none';
            if (startMenu) startMenu.style.display = 'none';
        }

        // Modal functions
        function addNewIcon() {
            const modalTitle = document.getElementById('modalTitle');
            const iconName = document.getElementById('iconName');
            const iconUrl = document.getElementById('iconUrl');
            const iconEmoji = document.getElementById('iconEmoji');
            const iconModal = document.getElementById('iconModal');

            if (modalTitle) modalTitle.textContent = 'Add New Icon';
            if (iconName) iconName.value = '';
            if (iconUrl) iconUrl.value = '';
            if (iconEmoji) iconEmoji.value = '🖥️';
            if (iconModal) iconModal.style.display = 'flex';
            hideAllMenus();
            currentIcon = null;
        }

        function editIcon(icon) {
            if (!icon) return;
            
            const modalTitle = document.getElementById('modalTitle');
            const iconName = document.getElementById('iconName');
            const iconUrl = document.getElementById('iconUrl');
            const iconEmoji = document.getElementById('iconEmoji');
            const iconModal = document.getElementById('iconModal');

            const nameElement = icon.querySelector('span');
            
            if (modalTitle) modalTitle.textContent = 'Edit Icon';
            if (iconName && nameElement) iconName.value = nameElement.textContent;
            if (iconUrl) iconUrl.value = icon.dataset.url || '';
            if (iconEmoji) iconEmoji.value = icon.dataset.icon || '🖥️';
            if (iconModal) iconModal.style.display = 'flex';
            hideAllMenus();
        }

        function deleteIcon(icon) {
            if (!icon) return;
            
            if (confirm('Are you sure you want to delete this icon?')) {
                icon.remove();
            }
            hideAllMenus();
        }

        function closeModal() {
            const iconModal = document.getElementById('iconModal');
            if (iconModal) {
                iconModal.style.display = 'none';
            }
        }

        function saveIcon() {
            const iconName = document.getElementById('iconName');
            const iconUrl = document.getElementById('iconUrl');
            const iconEmoji = document.getElementById('iconEmoji');

            if (!iconName || !iconUrl || !iconEmoji) {
                alert('Form elements not found.');
                return;
            }

            const name = iconName.value.trim();
            const url = iconUrl.value.trim();
            const emoji = iconEmoji.value;

            if (!name || !url) {
                alert('Please fill in all fields.');
                return;
            }

            if (currentIcon) {
                // Edit existing icon
                const nameElement = currentIcon.querySelector('span');
                const emojiElement = currentIcon.querySelector('.icon-emoji');
                if (nameElement) nameElement.textContent = name;
                if (emojiElement) emojiElement.textContent = emoji;
                currentIcon.dataset.url = url;
                currentIcon.dataset.icon = emoji;
            } else {
                // Create new icon - let the layout system position it
                const iconData = {
                    name: name,
                    url: url,
                    emoji: emoji,
                    id: Math.random().toString(36).substr(2, 9)
                };
                
                createIconElement(iconData);
                iconCounter++;
            }

            closeModal();
        }

        // Add a menu item for manual icon arrangement
        function addArrangeIconsMenuItem() {
            const contextMenu = document.getElementById('contextMenu');
            const startMenu = document.getElementById('startMenu');
            
            // Add to context menu
            const arrangeContextItem = document.createElement('div');
            arrangeContextItem.className = 'context-menu-item';
            arrangeContextItem.textContent = 'Auto Arrange Icons';
            arrangeContextItem.onclick = autoArrangeIcons;
            contextMenu.appendChild(arrangeContextItem);
            
            // Add to start menu
            const arrangeStartItem = document.createElement('div');
            arrangeStartItem.className = 'start-menu-item';
            arrangeStartItem.innerHTML = '<span>📐</span>Auto Arrange Icons';
            arrangeStartItem.onclick = () => {
                autoArrangeIcons();
                hideAllMenus();
            };
            startMenu.appendChild(arrangeStartItem);
        }

        // Call this after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing initialization code ...
            setTimeout(addArrangeIconsMenuItem, 100);
        });
    </script>
</body>
</html>
